// -----------------------------
// MongoDB Datasource
// -----------------------------
datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// -----------------------------
// ENUMS
// -----------------------------

/// Exercise type: either numeric load or boolean flag.
enum ExerciseType {
  NUMERIC
  BOOLEAN
}

/// Status of an activity in the plan.
enum ActivityStatus {
  PLANNED
  COMPLETED
  SKIPPED
}

/// Supported measurement units for exercises.
enum UnitType {
  KG /// weight in kilograms
  LB /// weight in pounds
  REP /// number of repetitions
  MIN /// time in minutes
  SEC /// time in seconds
  M /// distance in meters
  KM /// distance in kilometers
  CAL /// energy in calories
  NONE /// no measurable unit (e.g., stretching, mobility)
}

// -----------------------------
// TYPES
// -----------------------------

type ActivityGuidelines {
  /// How many times per week training sessions should occur.
  frequency_per_week    Int
  /// List of required exercise (by exercise ID) that must be included in the plan.
  required_exercise_ids String[]
}

type Metric {
  name        String
  unit        UnitType
  description String?
}

type MetricValue {
  metric Metric
  value  Float
}

// -----------------------------
// MODELS
// -----------------------------

/// User entity. Stores account data and owns projects.
model User {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  email     String    @unique
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  projects  Project[]

}

/// Project: represents a user-defined goal and links to one WorkoutPlan.
model Project {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  userId      String @db.ObjectId
  title       String
  description String

  /// Target metric extracted from title/description by AI.
  target_metric MetricValue?

  /// Current biometrics collected via form (based on template).
  current_metric MetricValue?

  /// Link to generated WorkoutPlan.
  workoutPlanId String?      @unique @db.ObjectId
  WorkoutPlan WorkoutPlan?
  /// Relation to User
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

/// Template that defines requirements and restrictions for generating a workout plan.
model ConfigTemplate {
  id                    String             @id @default(auto()) @map("_id") @db.ObjectId
  templateName          String
  /// Tags to categorize the template (e.g., "strength", "weight loss", "endurance").
  tags                  String[]
  /// Can be used in smart serach to find suitable templates if search by requiredTargetMetrics was unsuccessful.
  description           String?
  /// Target metrics to be achieved by the plan. Used in config search and generation.
  requiredTargetMetrics Metric
  /// Guidelines for scheduling activities in the plan.
  activityGuidelines    ActivityGuidelines
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  WorkoutPlan           WorkoutPlan[]
}

/// Global exercise definition (no load here).
model Exercise {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  /// Type of exercise: numeric load or boolean flag.
  type        ExerciseType
  /// Metrics that can be tracked for this exercise.
  loadMetrics Metric[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  /// Relation to scheduled activities using this exercise.
  activities  Activity[]

  @@index([title])
}

/// Workout plan connects a project to a configuration template and schedules activities.
model WorkoutPlan {
  id             String         @id @default(auto()) @map("_id") @db.ObjectId
  /// Link to the project this plan is for.
  projectId      String         @db.ObjectId
  project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)
  /// Link to the configuration template used to generate this plan.
  configTemplate ConfigTemplate @relation(fields: [templateId], references: [id])
  templateId     String         @db.ObjectId
  /// Relation to array of scheduled activities in this workout plan.
  activities     Activity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId])
  @@index([templateId])
}

/// Activity = scheduled instance of an exercise with load.
model Activity {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  /// Relation to the exercise being performed.
  exerciseId    String         @db.ObjectId
  exercise      Exercise       @relation(fields: [exerciseId], references: [id])
  /// Relation to the workout plan this activity belongs to.
  workoutPlan   WorkoutPlan    @relation(fields: [workoutPlanId], references: [id])
  workoutPlanId String         @db.ObjectId
  /// Date when the activity is scheduled.
  date          DateTime
  /// Planned load for the activity.
  planned_load  MetricValue[]
  /// Status of the activity (planned, completed, skipped).
  status        ActivityStatus @default(PLANNED)
  /// Actual load recorded after completion.
  actual_load   MetricValue[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workoutPlanId])
  @@index([exerciseId])
  @@index([date])
}
