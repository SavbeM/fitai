datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// Enum for input type expected in Activity (based on documentation: Numeric or Boolean)
enum EnumActivityInputType {
  NUMERIC // expects a number (e.g., reps, weight, distance)
  BOOLEAN // expects a boolean (e.g., completed or not)
}

// Main configuration template. Defines rules, structure, and boundaries for AI-based WorkoutPlan generation.
model ConfigTemplate {
  templateId         String   @id @default(auto()) @map("_id") @db.ObjectId // Unique identifier of the template (used to link with WorkoutPlan)
  templateName       String // Human-readable name of the template
  description        String // Description of what this template is for
  goalTypes          String[] // Supported goal types (e.g., ["muscle_gain", "weight_loss"])
  requiredBiometrics String[] // Required biometric fields (e.g., ["weight", "height"])
  activityGuidelines Json // Structural rules for activity generation (min/max activities, allowed types, field schemas, constraints)
  adaptationRules    Json // Adaptation logic for plan updates (e.g., onSkip, onComplete)
  aiPromptTemplate   String? // AI prompt with slots for dynamic content (optional)
  meta               Json? // Metadata: author, version, etc. (optional)
}

// Stores filled configuration for a specific user/project instance.
// Used as the basis for actual WorkoutPlan generation.
model WorkoutPlanConfig {
  configId        String   @id @default(auto()) @map("_id") @db.ObjectId // Unique config instance identifier
  templateId      String // Reference to ConfigTemplate.templateId
  projectId       String   @db.ObjectId // Project this config belongs to
  biometrics      Json // User biometrics at the time of config generation
  goal            String // Chosen goal for the plan
  activities      Json // Activity configs (list, as generated by AI and validated)
  adaptationRules Json // Copied or specialized adaptation logic for this config
  createdAt       DateTime @default(now()) // Generation timestamp
  meta            Json? // Additional metadata, for audit/versioning (optional)
}

// Represents the user's workout plan, generated via ConfigExecutor from WorkoutPlanConfig.
// Activities must strictly match ActivityConfig from template.
model WorkoutPlan {
  id                  String     @id @default(auto()) @map("_id") @db.ObjectId // Unique identifier
  projectId String   @unique @db.ObjectId // Project this plan belongs to 1:1
  project   Project  @relation(fields: [projectId], references: [id])
  configTemplateId    String // Source template (ConfigTemplate.templateId)
  generatedFromConfig String // Source config instance (WorkoutPlanConfig.configId)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt
  activities          Activity[] // List of scheduled activities (1:N)
}

// Activity generated for a workout plan.
// Follows structure defined in ActivityConfig within ConfigTemplate.activityGuidelines.
model Activity {
  id              String                @id @default(auto()) @map("_id") @db.ObjectId // Unique identifier
  workoutPlanId   String                @db.ObjectId // Linked WorkoutPlan
  date            DateTime // Scheduled date for the activity
  title           String // Short title/name of the activity
  description     String? // Detailed description (optional)
  type            EnumActivityInputType // Input type: Numeric or Boolean (from template)
  targetMetric    Float? // Target value (e.g., 50kg, 20 reps) or boolean as 0/1
  completedMetric Float? // Value input by user (actual result)
  unit            String? // Measurement unit ("kg", "reps", "minutes", etc.) (optional)
  adaptationRule  Json? // Adaptation logic for this activity (onSkip/onComplete) (optional)
  order           Int // Order of activity within the day/plan (if needed)
  workoutPlan     WorkoutPlan           @relation(fields: [workoutPlanId], references: [id]) // Linked WorkoutPlan
}

// Stores user account and login info.
model User {
  id       String    @id @default(auto()) @map("_id") @db.ObjectId // Unique identifier
  name     String // User's name
  email    String    @unique // Unique email for login
  projects Project[] // List of projects owned by this user
}

// Fitness project owned by user. Contains profile and generated workout plans.
model Project {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId // Unique identifier
  title         String // Project name/title
  description   String // Project description
  userId        String       @db.ObjectId // User who owns this project
  profile       Profile? // 1:1 relation with Profile
  user          User         @relation(fields: [userId], references: [id]) // User who owns this project
  workoutPlan WorkoutPlan? // 1:1 relation with WorkoutPlan
}

// Current user biometrics at the time of project creation.
model Profile {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId // Unique identifier
  biometrics Json // Current biometrics (e.g., {"weight": 95, "height": 180})
  targetBiometrics Json // Target biometrics (e.g., {"weight": 85, "height": 180})
  projectId  String  @unique @db.ObjectId // Project this profile belongs to
  project    Project @relation(fields: [projectId], references: [id]) // Project this profile belongs to
}
