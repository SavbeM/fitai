import {    mapToPrismaData,    RawUserCreateDTO,    RawUserUpdateDTO,    RawProjectCreateDTO,    RawProjectUpdateDTO,    RawActivityCreateDTO,    RawActivityUpdateDTO,    RawExerciseCreateDTO,    RawExerciseUpdateDTO, RawWorkoutPlanCreateDTO, RawConfigTemplateCreateDTO, RawWorkoutPlanUpdateDTO,    RawConfigTemplateUpdateDTO,} from "./mapPrismaData";import {handlePrismaError} from "@/utils/exceptionHandler";import {PrismaClient} from "@prisma/client";export const prisma = new PrismaClient();/*  databaseService: provides CRUD operations for all core entities.  Cascade logic is handled manually in service code â€” Prisma with MongoDB does NOT support ON DELETE CASCADE at schema level.*/export const databaseService = {    // ----- User -----    // Create a new user    createUser: async (userData: RawUserCreateDTO) => {        try {            const prismaData = mapToPrismaData("User", "create", userData);            return await prisma.user.create({data: prismaData});        } catch (error) {            handlePrismaError(error);        }    },    // Get user by ID with all related projects    getUserById: async (userId: string) => {        try {            return await prisma.user.findUnique({                where: {id: userId},                include: {projects: true},            });        } catch (error) {            handlePrismaError(error);        }    },    // Update user data (name and/or email)    updateUser: async (userData: RawUserUpdateDTO) => {        try {            const {id, ...raw} = userData;            const prismaData = mapToPrismaData("User", "update", raw);            return await prisma.user.update({                where: {id},                data: prismaData,            });        } catch (error) {            handlePrismaError(error);        }    },    // Delete user with cascade: removes all related projects and their entities    deleteUser: async (userId: string) => {        try {            const projects = await prisma.project.findMany({where: {userId}});            for (const project of projects) {                await databaseService.deleteProject(project.id);            }            return await prisma.user.delete({where: {id: userId}});        } catch (error) {            handlePrismaError(error);        }    },    // ----- Project -----    // Create new project for a user    createProject: async (projectData: RawProjectCreateDTO) => {        try {            const prismaData = mapToPrismaData("Project", "create", projectData);            return await prisma.project.create({                data: prismaData,            });        } catch (error) {            handlePrismaError(error);        }    },    // Get project by ID, include profile and workout plan with activities    getProjectById: async (projectId: string) => {        try {            return await prisma.project.findUnique({                where: {id: projectId},                include: {                    WorkoutPlan: {include: {activities: true}},                },            });        } catch (error) {            handlePrismaError(error);        }    },    // Update project title or description    updateProject: async (projectData: RawProjectUpdateDTO) => {        try {            const {id, ...raw} = projectData;            const prismaData = mapToPrismaData("Project", "update", raw);            return await prisma.project.update({                where: {id},                data: prismaData,            });        } catch (error) {            handlePrismaError(error);        }    },    // Delete project with cascade: removes all related workout plans, activities, profile, configs    deleteProject: async (projectId: string) => {        try {            return await prisma.$transaction(async (tx) => {                // select ids of all workout plans related to the project                const plans = await tx.workoutPlan.findMany({                    where: { projectId },                    select: { id: true }                });                // extract ids into array                const planIds = plans.map(p => p.id);                await tx.activity.deleteMany({                    where: {                        workoutPlanId: { in: planIds }                    }                });                await tx.workoutPlan.deleteMany({                    where: { projectId }                });                await tx.project.delete({                    where: { id: projectId }                });            });        } catch (error) {            handlePrismaError(error);        }    },    // ----- ConfigTemplate -----    // Get config template by ID    getConfigTemplateById: async (templateId: string) => {        try {            return await prisma.configTemplate.findUnique({                where: { id: templateId },                include: {                    recommendedExercises: {                        include: { exercise: true },                    },                },            });        } catch (error) {            handlePrismaError(error);        }    },    // Get all config templates    getAllConfigTemplates: async () => {        try {            return await prisma.configTemplate.findMany({                include: {                    recommendedExercises: {                        include: { exercise: true },                    },                },            });        } catch (error) {            handlePrismaError(error);        }    },    createConfigTemplate: async (configData: RawConfigTemplateCreateDTO) => {        try {            const prismaData = mapToPrismaData("ConfigTemplate", "create", configData);            return await prisma.configTemplate.create({                data: prismaData,                include: {                    recommendedExercises: {                        include: { exercise: true },                    },                },            });        } catch (error) {            handlePrismaError(error);        }    },    updateConfigTemplate: async (configData: RawConfigTemplateUpdateDTO) => {        try {            const { id, ...raw } = configData;            const prismaData = mapToPrismaData("ConfigTemplate", "update", raw);            return await prisma.configTemplate.update({                where: { id },                data: prismaData,                include: {                    recommendedExercises: {                        include: { exercise: true },                    },                },            });        } catch (error) {            handlePrismaError(error);        }    },    deleteConfigTemplate: async (templateId: string) => {        try {            // Manual cleanup for Mongo to avoid orphaned join documents.            await prisma.configTemplateRecommendedExercise.deleteMany({                where: { templateId },            });            return await prisma.configTemplate.delete({                where: { id: templateId },            });        } catch (error) {            handlePrismaError(error);        }    },    // ----- WorkoutPlan -----    // Create WorkoutPlan (bind to config/template/project)    createWorkoutPlan: async (workoutData: RawWorkoutPlanCreateDTO) => {        try {            const prismaData = mapToPrismaData("WorkoutPlan", "create", workoutData);            return await prisma.workoutPlan.create({                data: prismaData,            });        } catch (error) {            handlePrismaError(error);        }    },    updateWorkoutPlan: async (workoutPlanData: RawWorkoutPlanUpdateDTO) => {        try {            const {id, ...raw} = workoutPlanData;            const prismaData = mapToPrismaData("WorkoutPlan", "update", raw);            return await prisma.workoutPlan.update({                where: {id},                data: prismaData,            });        }        catch (error) {            handlePrismaError(error);        }    },    // Get all workout plans for a project (with activities)    getWorkoutPlansByProjectId: async (projectId: string) => {        try {            return await prisma.workoutPlan.findMany({                where: {projectId},                include: {activities: true},            });        } catch (error) {            handlePrismaError(error);        }    },    // Delete workout plan with all related activities    deleteWorkoutPlan: async (workoutPlanId: string) => {        try {            await prisma.activity.deleteMany({where: {workoutPlanId}});            return await prisma.workoutPlan.delete({where: {id: workoutPlanId}});        } catch (error) {            handlePrismaError(error);        }    },    // ----- Activity -----    // Create new activity for workout plan    createActivity: async (data: RawActivityCreateDTO) => {        try {            const prismaData = mapToPrismaData("Activity", "create", data);            return await prisma.activity.create({                data: prismaData,            });        } catch (error) {            handlePrismaError(error);        }    },    // Get all activities for a workout plan    getActivitiesByWorkoutPlanId: async (workoutPlanId: string) => {        try {            return await prisma.activity.findMany({where: {workoutPlanId}});        } catch (error) {            handlePrismaError(error);        }    },    // Update activity (for example: completedMetric, etc.)    updateActivity: async (data: RawActivityUpdateDTO) => {        try {            const {id, ...raw} = data;            const prismaData = mapToPrismaData("Activity", "update", raw);            return await prisma.activity.update({where: {id}, data: prismaData});        } catch (error) {            handlePrismaError(error);        }    },    // Delete activity    deleteActivity: async (activityId: string) => {        try {            return await prisma.activity.delete({where: {id: activityId}});        } catch (error) {            handlePrismaError(error);        }    },    // ----- Exercise -----    createExercise: async (data: RawExerciseCreateDTO) => {        try {            const prismaData = mapToPrismaData("Exercise", "create", data);            return await prisma.exercise.create({ data: prismaData });        } catch (error) {            handlePrismaError(error);        }    },    getExerciseByID: async (exerciseId: string) => {        try {            return await prisma.exercise.findUnique({ where: { id: exerciseId } });        } catch (error) {            handlePrismaError(error);        }    },    updateExercise: async (data: RawExerciseUpdateDTO) => {        try {            const { id, ...raw } = data;            const prismaData = mapToPrismaData("Exercise", "update", raw);            return await prisma.exercise.update({ where: { id }, data: prismaData });        } catch (error) {            handlePrismaError(error);        }    },    deleteExerciseByID: async (exerciseId: string) => {        try {            await prisma.configTemplateRecommendedExercise.deleteMany({                where: { exerciseId },            });            return await prisma.exercise.delete({ where: { id: exerciseId } });        } catch (error) {            handlePrismaError(error);        }    },};